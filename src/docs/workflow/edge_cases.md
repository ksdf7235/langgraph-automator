# Workflow 엣지 케이스 및 Known Issues

## 엣지 케이스

### 1. 서브그래프 실행 실패
**증상:** 서브그래프 내부에서 에러 발생

**원인:**
- 서브그래프 내부 노드 실패
- 네트워크 오류
- 파일 시스템 오류

**대응:**
- 서브그래프 내부 노드의 재시도 로직 적용
- 명확한 에러 메시지 전파
- 서브그래프 레벨 재시도는 현재 미지원 (향후 확장 가능)

---

### 2. 서브그래프 간 상태 불일치
**증상:** 이전 서브그래프의 결과가 다음 서브그래프에서 유효하지 않음

**원인:**
- 상태 필드 누락
- 데이터 형식 불일치

**대응:**
- 각 서브그래프에서 필요한 필드 검증
- 명확한 에러 메시지 제공

**예방:**
- VideoState 타입 정의 준수
- 각 서브그래프의 입력/출력 문서화

---

### 3. 캐시 불일치
**증상:** 캐시된 데이터와 실제 파일 불일치

**원인:**
- 파일 삭제
- 캐시 파일 손상

**대응:**
- 캐시 조회 시 파일 존재 확인
- 파일이 없으면 캐시 무효화

**구현:**
- `WorkflowCache.get_stage()`에서 파일 검증
- 파일이 없으면 `None` 반환하여 재생성

---

### 4. 메인 그래프 실행 중 중단
**증상:** 사용자가 Ctrl+C로 중단

**원인:**
- 사용자 입력
- 시스템 종료

**대응:**
- KeyboardInterrupt 예외 처리
- 진행 중인 작업은 완료될 수 있음 (서브그래프 레벨)

**향후 개선:**
- 체크포인트 사용으로 중단 지점 저장
- 재개 기능 추가

---

## Known Issues

### 1. 서브그래프 레벨 재시도 미지원
**문제:** 서브그래프 전체가 실패했을 때 재시도하는 메커니즘이 없음

**영향:** 일시적인 네트워크 오류 등으로 인한 실패 시 수동 재시도 필요

**해결 방안:**
- 메인 오케스트레이터 레벨에서 서브그래프 재시도 래퍼 추가 (향후)
- 조건부 재시도 (예: 네트워크 오류만 재시도)

---

### 2. 서브그래프 병렬 실행 미지원
**문제:** 현재는 모든 서브그래프가 순차적으로 실행됨

**영향:** 전체 실행 시간이 길어질 수 있음

**참고:**
- Script → Asset → Video 순서는 의존성을 가지므로 병렬화 불가
- Asset Generation 서브그래프 내부 노드 간 병렬화는 가능 (향후)

---

### 3. 서브그래프 실행 시간 모니터링 미지원
**문제:** 각 서브그래프의 실행 시간을 추적하지 않음

**영향:** 성능 분석 어려움

**해결 방안:**
- 로깅 개선 (실행 시간 기록)
- 메트릭 수집 도구 통합 (향후)

---

### 4. 체크포인트 기능 미완성
**문제:** checkpoint 파라미터가 있지만 실제로는 메모리 기반만 지원

**영향:** 장기 실행 워크플로우에서 상태 복구 어려움

**해결 방안:**
- 파일 기반 체크포인트 지원 (향후)
- 데이터베이스 기반 체크포인트 지원 (향후)

---

## 버그 이력

### 버그 #1: 서브그래프 호출 시 상태 불일치
**날짜:** 2024-12 (추정)
**증상:** 서브그래프 간 상태 전달 시 필드 누락

**원인:** 서브그래프 호출 시 상태 복사 방식 문제

**해결:**
- 서브그래프 래퍼에서 상태 전달 방식 개선
- 상태 병합 로직 명확화

**상태:** 해결됨 (예상)

---

## 향후 개선 사항

1. **서브그래프 레벨 재시도**
   - 메인 오케스트레이터에서 서브그래프 실패 시 재시도 옵션

2. **조건부 분기**
   - 대본 길이 초과 시 Script Pipeline 재실행
   - 에셋 품질 검증 후 재생성

3. **병렬 실행 최적화**
   - Asset Generation 내부 노드 병렬화
   - 여러 비디오 동시 생성

4. **모니터링 및 로깅**
   - 각 서브그래프 실행 시간 추적
   - 진행 상황 시각화

5. **체크포인트 개선**
   - 파일 기반 체크포인트
   - 부분 재시작 기능
