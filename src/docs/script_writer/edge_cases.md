# Script Writer 엣지 케이스 및 Known Issues

## 엣지 케이스

### 1. LLM 응답에 JSON이 없는 경우

**증상:** `extract_json_from_text()`가 JSON을 찾지 못함

**원인:**

- LLM이 JSON 형식을 따르지 않음
- `<think>` 블록만 반환
- 코드 블록 없이 텍스트만 반환

**대응:**

- `extract_json_from_text()`에서 정규식으로 JSON 객체 직접 검색
- 실패 시 상세한 에러 메시지와 원본 텍스트 일부 로깅
- `ValueError` 발생

**해결 전략:**

- 프롬프트에서 JSON 출력을 강하게 요구
- 재시도 로직 (워크플로우 레벨에서 처리)

---

### 2. LLM 응답이 타임아웃되는 경우

**증상:** `requests.post()` 호출이 600초 내에 완료되지 않음

**원인:**

- DeepSeek R1 14B 모델이 긴 프롬프트 처리 시 시간 소요
- Ollama 서버 부하
- 네트워크 문제

**대응:**

- 타임아웃을 600초(10분)로 설정
- 타임아웃 발생 시 `requests.Timeout` 예외 발생

**해결 전략:**

- Ollama 서버 상태 확인
- 프롬프트 최적화 (불필요한 내용 제거)
- 모델 변경 고려

---

### 3. scenes 배열이 비어있는 경우

**증상:** `scenes`가 빈 리스트 `[]`

**원인:**

- LLM이 장면을 생성하지 않음
- JSON 구조는 맞지만 내용이 없음

**대응:**

- `generate_script()`에서 `len(scenes) == 0` 체크
- `ValueError` 발생

**해결 전략:**

- 프롬프트에서 최소 장면 수 명시 (3~4개)
- 재시도 로직

---

### 4. 장면에 필수 필드가 없는 경우

**증상:** `scene` 딕셔너리에 `script` 또는 `image_prompt` 키가 없음

**원인:**

- LLM이 불완전한 JSON 생성
- JSON 파싱은 성공했지만 구조가 불완전

**대응:**

- `generate_script()`에서 각 장면에 `setdefault()` 사용
- 필수 필드를 빈 문자열로 초기화

**해결 전략:**

- 프롬프트에서 필수 필드 명시
- JSON 스키마 검증 추가 고려

---

### 5. `<think>` 태그가 닫히지 않은 경우

**증상:** 정규식 매칭 실패

**원인:**

- LLM이 태그를 올바르게 닫지 않음
- 중첩된 태그

**대응:**

- `extract_json_from_text()`에서 `re.DOTALL` 플래그 사용
- 태그 제거 후 JSON 검색

**해결 전략:**

- 현재 구현으로 대부분 처리됨
- 추가 검증 로직 불필요

---

## Known Issues

### 1. 프롬프트 길이에 따른 성능 저하

**문제:** 긴 프롬프트는 LLM 처리 시간이 길어짐

**영향:** 타임아웃 발생 가능성 증가

**해결 방안:**

- 프롬프트 최적화 (불필요한 예시 제거)
- 프롬프트 템플릿 캐싱

---

### 2. JSON 파싱 실패 시 재시도 없음

**문제:** JSON 파싱 실패 시 즉시 에러 발생

**영향:** 일시적인 LLM 출력 문제로 인한 실패

**해결 방안:**

- 워크플로우 레벨에서 재시도 데코레이터 사용
- `retry_node` 데코레이터 적용 (현재 적용됨)

---

### 3. 대본 저장 실패 시 무시

**문제:** `script.json` 저장 실패 시 경고만 출력하고 계속 진행

**영향:** 디버깅 시 대본 확인 불가

**해결 방안:**

- 저장 실패 시에도 프로세스는 계속 (대본은 메모리에 있음)
- 로그에 상세 정보 기록

---

## 버그 이력

### 버그 #1: 타임아웃이 너무 짧았던 문제

**날짜:** 2024-12 (추정)
**증상:** DeepSeek R1 14B 호출 시 타임아웃 발생

**원인:** 기본 타임아웃이 120초였음

**해결:**

- 타임아웃을 600초(10분)로 증가
- `call_ollama()` 함수 수정

**상태:** 해결됨

---

### 버그 #2: JSON 추출 실패

**날짜:** 2024-12 (추정)
**증상:** LLM 출력에서 JSON을 찾지 못함

**원인:** `<think>` 태그 처리 미흡

**해결:**

- `extract_json_from_text()`에서 태그 제거 로직 추가
- 정규식 개선

**상태:** 해결됨
